First, I discovered code in `channel.php` that is likely susceptible to a Local File Inclusion vulnerability.

![image-20240116202350796](forucms.assets/image-20240116202350796.png)

Consequently, I opted to trace the origins of these two variables:

`$t_path`

```php
$t_path = TPL_DIR . '/' . (!empty($_COOKIE['cms']['template_id']) ? $_COOKIE['cms']['template_id'] : $cms['s_template']) . '/';
$GLOBALS['t_path'] = &$t_path;
```

`$channel['c_cmodel']`

```php
  public function getChannel($id) {
    return $this->db->getRow("SELECT * FROM channel WHERE id = $id");
  }
```

In the backend, we can control the value of `c_cmodel`.

```php
  $sql = "INSERT INTO channel ".arr_insert($data);
  $dataops->ops($sql, '频道新增', 1);
```

Therefore, we can fully control the value in the entire `channel.php`, leading to an LFI (Local File Inclusion).

However, I found that due to an issue with the author's code, I am unable to modify the value of `c_cmodel` in the
backend.

![image-20240116203046468](forucms.assets/image-20240116203046468.png)

All keys and values must pass through the `arr_insert()` function.

![image-20240116203123857](forucms.assets/image-20240116203123857.png)

This function will perform a `str_safe` operation on the keys:

![image-20240116203203125](forucms.assets/image-20240116203203125.png)

And I eventually discovered that `str_safe` will ultimately call the `str_isafe()` method, which will turn `script`
into `&#115;cript`. The author's intention may have been good, however, our key contains such a field:

```php
$data['c_description'] = $_POST['c_description'];
```

Therefore, this key will be escaped and ultimately cannot be inserted into the table.

So, I chose to search for an SQL injection vulnerability to help me directly modify this table.

As a result, I performed a global search for `select` and found that many instances have been converted to integer
types.

![image-20240110170829048](forucms.assets/image-20240110170829048.png)

However, this particular instance was not: `cms_admin.php`.

![image-20240110170852366](forucms.assets/image-20240110170852366.png)

It is necessary to specify the parameters in the request packet: `act=add&a_name=123`.

I then used my SQLMAP to attempt an SQL injection and obtained satisfactory results:

![image-20240110171022936](forucms.assets/image-20240110171022936.png)

Next, I need to retrieve two things: the `database name` and the `table name`.

The error reporting on this site has some issues, and SQLMAP is unable to retrieve the result of `--current-db`.
However, we have `CVE-2024-0426`, a useful backend Insert-type SQL injection, which we can leverage:

```sql
333',(select database())); #
```

![image-20240110172426238](forucms.assets/image-20240110172426238.png)

Table name prefix:

Use `-v 6` to view the data generated by SQLMAP's injection. The error reveals the table name prefix:

![image-20240110172553886](forucms.assets/image-20240110172553886.png)

Upload an image Webshell and obtain the path.

![image-20240110172810932](forucms.assets/image-20240110172810932.png)

Finally, use SQLMAP's `--sql-shell` to execute arbitrary SQL statements:

```sql
UPDATE xhcms.cms_channel SET c_cmodel = '../../uploadfile/image/20240110/20240110172804_14729.png' WHERE id = 5;
```

![image-20240116204050531](forucms.assets/image-20240116204050531.png)

